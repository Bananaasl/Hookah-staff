<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hookah Staff - Управление табаками</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            min-height: 100vh;
            line-height: 1.6;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 30px 40px;
            min-height: 80px;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-center h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 8px 0;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-center p {
            font-size: 1.1rem;
            color: #6c757d;
            font-weight: 400;
            margin: 0;
        }

        .header-profile {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-info {
            text-align: right;
        }

        .profile-role {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .profile-username {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        .logout-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
        }

        .logout-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }

        .logout-button svg {
            transition: transform 0.2s ease;
        }

        .logout-button:hover svg {
            transform: translateX(-2px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .add-button-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .add-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.2);
        }

        .add-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        }

        .add-form {
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #e9ecef;
        }

        .add-form h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #495057;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 6px;
            color: #495057;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #6c757d;
            box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.1);
        }

        .fortress-text {
            color: #6c757d;
            font-weight: 500;
            margin-left: 8px;
            font-size: 0.9rem;
        }

        /* Стили для рекомендаций */
        .suggestions-container {
            margin-top: 8px;
        }

        .suggestions-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .suggestions-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .suggestion-chip {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #bbdefb;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 0.8rem;
            color: #1976d2;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .suggestion-chip:hover {
            background: linear-gradient(135deg, #1976d2 0%, #7b1fa2 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        }

        .suggestion-chip:active {
            transform: translateY(0);
        }

        .save-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        }

        .tobacco-list h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .tobacco-table {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #e9ecef;
        }

        .table-container {
            width: 100%;
        }

        .table-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .table-header h3 {
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto; /* Автоматическая разметка для адаптации к содержимому */
        }

        .table th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: visible;
        }

        .table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f3f4;
            color: #495057;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: visible;
            text-align: center;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Специальные стили для колонок с минимальными размерами */
        .table th:nth-child(1), .table td:nth-child(1) { /* Бренд */
            min-width: 80px;
        }
        
        .table th:nth-child(2), .table td:nth-child(2) { /* Вкус */
            min-width: 70px;
        }
        
        .table th:nth-child(3), .table td:nth-child(3) { /* Крепость */
            min-width: 100px;
        }
        
        .table th:nth-child(4), .table td:nth-child(4) { /* Цена */
            min-width: 80px;
        }
        
        .table th:nth-child(5), .table td:nth-child(5) { /* Вес */
            min-width: 60px;
        }
        
        .table th:nth-child(6), .table td:nth-child(6) { /* Дата заказа */
            min-width: 100px;
        }
        
        .table th:nth-child(7), .table td:nth-child(7) { /* Дата инвентаризации */
            min-width: 120px;
        }
        
        .table th:nth-child(8), .table td:nth-child(8) { /* Вес на инвентаризации */
            min-width: 140px;
        }
        
        .table th:nth-child(9), .table td:nth-child(9) { /* Использование */
            min-width: 80px;
        }
        
        .table th:nth-child(10), .table td:nth-child(10) { /* Действия */
            min-width: 80px;
        }

        .fortress-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #ffffff;
            display: inline-block;
        }

        .fortress-light {
            background: #28a745;
        }

        .fortress-medium {
            background: #ffc107;
            color: #212529;
        }

        .fortress-strong {
            background: #dc3545;
        }

        .price {
            color: #495057;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state p:first-child {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .delete-button {
            background: #dc3545;
            color: #ffffff;
            border: none;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-button:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .app {
                padding: 10px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
                text-align: center;
            }

            .header-center h1 {
                font-size: 2rem;
            }

            .header-profile {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }

            .profile-info {
                text-align: center;
            }

            .logout-button {
                width: 100%;
                justify-content: center;
            }

            .login-container {
                min-height: 50vh;
                padding: 10px;
            }

            .login-card {
                padding: 30px 20px;
                border-radius: 16px;
            }

            .login-icon {
                width: 60px;
                height: 60px;
            }

            .login-header h2 {
                font-size: 1.5rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }

            .table {
                font-size: 0.8rem;
            }

            .table th,
            .table td {
                padding: 8px 4px;
            }
        }

        @media (max-width: 480px) {
            .table {
                font-size: 0.75rem;
            }

            .table th,
            .table td {
                padding: 6px 2px;
            }
        }

        @media (max-width: 360px) {
            .table {
                font-size: 0.7rem;
            }

            .table th,
            .table td {
                padding: 4px 1px;
            }
        }

        /* Стили для вкладок */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #495057;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #495057;
            border-bottom-color: #6c757d;
            background: #f8f9fa;
        }

        /* Стили для карточек привозов */
        .delivery-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .delivery-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .delivery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-color: #6c757d;
        }

        .delivery-date {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }

        .delivery-info {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .delivery-info div {
            margin-bottom: 5px;
        }

        /* Стили для модального окна */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #495057;
        }

        /* Стили для истории */
        .history-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Стили для формы авторизации */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            border: 1px solid #e9ecef;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border-radius: 50%;
            color: white;
            margin-bottom: 20px;
        }

        .login-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 8px 0;
        }

        .login-header p {
            color: #6c757d;
            font-size: 1rem;
            margin: 0;
        }

        .login-form {
            margin-bottom: 30px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-input:focus {
            outline: none;
            border-color: #6c757d;
            background: white;
            box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.1);
        }

        .form-input::placeholder {
            color: #adb5bd;
        }

        .login-button {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.2);
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        }

        .login-button svg {
            transition: transform 0.2s ease;
        }

        .login-button:hover svg {
            transform: translateX(2px);
        }

        .login-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }

        .info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .info-header svg {
            color: #6c757d;
        }

        .info-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-role {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .role-name {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .role-credentials {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        // Интерфейсы для TypeScript
        const Tobacco = {
            id: null,
            brand_name: '',
            fortress: 1,
            price: 0,
            weight: 50,
            orderDate: null,
            inventoryDate: null,
            inventoryWeight: 50,
            taste: '',
            tastes: []
        };

        const Taste = {
            id: null,
            name: '',
            description: ''
        };

        // API URL
        const API_BASE_URL = 'http://localhost:8080/api/tobacco';

        // Основное приложение
        class HookahStaffApp {
            constructor() {
                this.tobaccos = [];
                this.multiBrands = []; // Список брендов с вкусами для множественного добавления
                this.showMultiBrandForm = false;
                this.currentUser = null;
                this.currentDelivery = null;
                this.finalizedDeliveries = [];
                this.activeTab = 'current'; // 'current' или 'history'
                this.showDeliveryModal = false;
                this.selectedDelivery = null;
                
                // Данные для рекомендаций
                this.brandSuggestions = ['Overdos', 'Deus', 'НАШ', 'Darkside Sabotage', 'JENT', 'JENT CIGAR', 'Sapphire Crown', 'Хулиган', 'Догма', 'Muassel', 'BLISS', 'DUFT', 'КОБРА', 'Afzal', 'Сарма', 'Сарма 360', 'SEBERO CLASSIC', 'SEBERO BLACK', 'Spectrum', 'NАШ Cigar', 'Северный', 'Kraken', 'Palitra', 'CHABACO', 'Darkside', 'Trofimoff', 'Bonche', 'Satyr', 'Black Burn', 'Star line', 'Mast Have'];
                this.tasteSuggestions = ['Малина', 'Смородина', 'Супернова', 'Груша', 'Липа', 'Бергамот', 'Клубника', 'Апельсин', 'Мята', 'Лимон', 'Киви', 'Персик', 'Ананас', 'Кокос', 'Ваниль'];
                this.priceSuggestions = [720, 1200, 2000];
                
                // Маппинг цен на веса
                this.priceToWeightMapping = {
                    720: 100,
                    1200: 125,
                    2000: 200
                };
                
                this.init();
            }

            async init() {
                // Проверяем, есть ли сохраненный токен
                const savedToken = localStorage.getItem('authToken');
                if (savedToken) {
                    // Здесь можно добавить проверку токена на сервере
                    this.currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    await this.loadData();
                } else {
                    this.render();
                }
            }

            async loadData() {
                await this.loadTobaccos();
                await this.loadCurrentDelivery();
                await this.loadFinalizedDeliveries();
                this.render();
            }

            async loadTobaccos() {
                try {
                    const response = await fetch(`${API_BASE_URL}/current`);
                    if (response.ok) {
                        const data = await response.json();
                        this.tobaccos = Array.isArray(data) ? data : [];
                        console.log('Загружено табаков:', this.tobaccos.length);
                    } else {
                        console.error('Ошибка загрузки табаков:', response.statusText);
                        this.tobaccos = [];
                        this.showNotification('Ошибка загрузки данных', 'error');
                    }
                } catch (error) {
                    console.error('Ошибка загрузки табаков:', error);
                    this.tobaccos = [];
                    this.showNotification('Ошибка подключения к серверу', 'error');
                }
            }

            async loadCurrentDelivery() {
                try {
                    const response = await fetch('http://localhost:8080/api/delivery/current');
                    if (response.ok) {
                        const data = await response.json();
                        this.currentDelivery = data;
                    } else {
                        this.currentDelivery = null;
                    }
                } catch (error) {
                    console.error('Ошибка загрузки текущего привоза:', error);
                    this.currentDelivery = null;
                }
            }

            async loadFinalizedDeliveries() {
                try {
                    const response = await fetch('http://localhost:8080/api/delivery/finalized');
                    if (response.ok) {
                        const data = await response.json();
                        this.finalizedDeliveries = Array.isArray(data) ? data : [];
                    } else {
                        this.finalizedDeliveries = [];
                    }
                } catch (error) {
                    console.error('Ошибка загрузки завершенных привозов:', error);
                    this.finalizedDeliveries = [];
                }
            }

            async login(username, password) {
                try {
                    const response = await fetch('http://localhost:8080/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentUser = data;
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('currentUser', JSON.stringify(data));
                        await this.loadData();
                        this.showNotification(`Добро пожаловать, ${data.username}!`, 'success');
                    } else {
                        const errorText = await response.text();
                        this.showNotification(errorText, 'error');
                    }
                } catch (error) {
                    console.error('Ошибка авторизации:', error);
                    this.showNotification('Ошибка подключения к серверу', 'error');
                }
            }

            logout() {
                this.currentUser = null;
                this.tobaccos = [];
                this.currentDelivery = null;
                this.finalizedDeliveries = [];
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                this.render();
                this.showNotification('Вы вышли из системы', 'info');
            }

            async createNewDelivery() {
                try {
                    const response = await fetch('http://localhost:8080/api/delivery/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `createdBy=${this.currentUser.username}`
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentDelivery = data;
                        this.showNotification('Новый привоз создан!', 'success');
                        this.render();
                    } else {
                        const errorText = await response.text();
                        this.showNotification(errorText, 'error');
                    }
                } catch (error) {
                    console.error('Ошибка создания привоза:', error);
                    this.showNotification('Ошибка создания привоза', 'error');
                }
            }

            async createNewDeliveryWithForm() {
                try {
                    const response = await fetch('http://localhost:8080/api/delivery/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `createdBy=${this.currentUser.username}`
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentDelivery = data;
                        this.showMultiBrandForm = true;
                        this.showNotification('Новый привоз создан! Теперь добавьте табаки.', 'success');
                        this.render();
                    } else {
                        const errorText = await response.text();
                        this.showNotification(errorText, 'error');
                    }
                } catch (error) {
                    console.error('Ошибка создания привоза:', error);
                    this.showNotification('Ошибка создания привоза', 'error');
                }
            }

            async finalizeDelivery() {
                if (!this.currentDelivery) {
                    this.showNotification('Нет активного привоза для завершения', 'error');
                    return;
                }

                if (!confirm('Вы уверены, что хотите завершить этот привоз? После завершения его нельзя будет изменить.')) {
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:8080/api/delivery/${this.currentDelivery.id}/finalize`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `finalizedBy=${this.currentUser.username}`
                    });

                    if (response.ok) {
                        this.showNotification('Привоз успешно завершен!', 'success');
                        await this.loadData();
                    } else {
                        const errorText = await response.text();
                        this.showNotification(errorText, 'error');
                    }
                } catch (error) {
                    console.error('Ошибка завершения привоза:', error);
                    this.showNotification('Ошибка завершения привоза', 'error');
                }
            }

            async cancelDelivery() {
                if (!this.currentDelivery) {
                    this.showNotification('Нет активного привоза для отмены', 'error');
                    return;
                }

                if (!confirm('Вы уверены, что хотите отменить этот привоз? Все добавленные табаки будут удалены.')) {
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:8080/api/delivery/${this.currentDelivery.id}/cancel`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.showNotification('Привоз успешно отменен!', 'success');
                        await this.loadData();
                    } else {
                        const errorText = await response.text();
                        this.showNotification(errorText, 'error');
                    }
                } catch (error) {
                    console.error('Ошибка отмены привоза:', error);
                    this.showNotification('Ошибка отмены привоза', 'error');
                }
            }

            async showDeliveryDetails(deliveryId) {
                try {
                    // Загружаем табаки и стоимость привоза параллельно
                    const [tobaccosResponse, costResponse] = await Promise.all([
                        fetch(`http://localhost:8080/api/delivery/${deliveryId}/tobaccos`),
                        fetch(`http://localhost:8080/api/delivery/${deliveryId}/cost`)
                    ]);

                    if (tobaccosResponse.ok && costResponse.ok) {
                        const tobaccos = await tobaccosResponse.json();
                        const cost = await costResponse.json();
                        this.selectedDelivery = { id: deliveryId, tobaccos, cost };
                        this.showDeliveryModal = true;
                        this.render();
                    } else {
                        this.showNotification('Ошибка загрузки деталей привоза', 'error');
                    }
                } catch (error) {
                    console.error('Ошибка загрузки деталей привоза:', error);
                    this.showNotification('Ошибка загрузки деталей привоза', 'error');
                }
            }

            closeDeliveryModal() {
                this.showDeliveryModal = false;
                this.selectedDelivery = null;
                this.render();
            }

            switchTab(tab) {
                this.activeTab = tab;
                this.render();
            }

            handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (!username || !password) {
                    this.showNotification('Пожалуйста, заполните все поля', 'error');
                    return;
                }
                
                this.login(username, password);
            }

            getFortressClass(fortress) {
                if (fortress <= 2) return 'fortress-light';
                if (fortress <= 4) return 'fortress-medium';
                return 'fortress-strong';
            }

            getFortressText(fortress) {
                if (fortress <= 2) return 'Легкий';
                if (fortress <= 4) return 'Средний';
                return 'Крепкий';
            }

            // Функции для работы с рекомендациями
            selectBrandSuggestion(brandIndex, brandName) {
                this.updateBrand(brandIndex, 'brandName', brandName);
            }

            selectTasteSuggestion(brandIndex, taste) {
                const currentTastes = this.multiBrands[brandIndex].tastes;
                // Добавляем вкус каждый раз при нажатии (убираем проверку на дубликаты)
                currentTastes.push(taste);
                this.updateBrandTastes(brandIndex, currentTastes.join(', '));
            }

            selectWeightSuggestion(brandIndex, weight) {
                this.updateBrand(brandIndex, 'weight', weight);
            }

            selectPriceSuggestion(brandIndex, price) {
                this.updateBrand(brandIndex, 'price', price);
                // Автоматически устанавливаем вес в зависимости от цены
                const weight = this.priceToWeightMapping[price];
                if (weight) {
                    this.updateBrand(brandIndex, 'weight', weight);
                }
            }

            renderSuggestions(suggestions, type, brandIndex) {
                const typeLabels = {
                    'brand': 'бренды',
                    'taste': 'вкусы',
                    'price': 'цены'
                };
                
                // Не показываем рекомендации по весу, так как вес устанавливается автоматически
                if (type === 'weight') {
                    return '';
                }
                
                return `
                    <div class="suggestions-container">
                        <div class="suggestions-label">Популярные ${typeLabels[type]}:</div>
                        <div class="suggestions-chips">
                            ${suggestions.map(suggestion => {
                                const value = type === 'price' ? suggestion : `'${suggestion}'`;
                                const displayValue = type === 'price' ? `${suggestion} ₽` : suggestion;
                                return `
                                    <div class="suggestion-chip" onclick="app.select${type.charAt(0).toUpperCase() + type.slice(1)}Suggestion(${brandIndex}, ${value})">
                                        ${displayValue}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            calculateUsagePercentage(tobacco) {
                const orderWeight = tobacco.weight || 0;
                const inventoryWeightInGrams = this.getInventoryWeightInGrams(tobacco);
                
                if (orderWeight === 0) return 0;
                
                const usedWeight = orderWeight - inventoryWeightInGrams;
                const percentage = (usedWeight / orderWeight) * 100;
                
                return Math.max(0, Math.min(100, Math.round(percentage)));
            }

            // Функция для получения веса инвентаризации в граммах
            getInventoryWeightInGrams(tobacco) {
                const inventoryWeight = tobacco.inventoryWeight || 0;
                const orderWeight = tobacco.weight || 0;
                
                // Если inventoryWeight больше orderWeight, значит это процент
                if (inventoryWeight > orderWeight && inventoryWeight <= 100) {
                    // Это процент, конвертируем в граммы
                    return Math.round((inventoryWeight / 100) * orderWeight);
                }
                
                // Иначе это уже граммы
                return inventoryWeight;
            }

            getUsageColor(percentage) {
                if (percentage <= 30) return '#28a745'; // Зеленый - мало использован
                if (percentage <= 70) return '#ffc107'; // Желтый - средне использован
                return '#dc3545'; // Красный - много использован
            }


            async handleMultiBrandAddTobaccos() {
                // Проверяем, есть ли активный привоз
                if (!this.currentDelivery) {
                    this.showNotification('Сначала создайте привоз', 'error');
                    return;
                }

                // Валидация формы
                if (this.multiBrands.length === 0) {
                    alert('Пожалуйста, добавьте хотя бы один бренд');
                    return;
                }

                for (let i = 0; i < this.multiBrands.length; i++) {
                    const brand = this.multiBrands[i];
                    
                    if (!brand.brandName || brand.brandName.trim() === '') {
                        alert(`Пожалуйста, введите название бренда для бренда ${i + 1}`);
                        return;
                    }
                    
                    if (!brand.price || brand.price <= 0) {
                        alert(`Пожалуйста, введите корректную цену для бренда "${brand.brandName}"`);
                        return;
                    }
                    
                    if (!brand.weight || brand.weight <= 0) {
                        alert(`Пожалуйста, введите корректный вес для бренда "${brand.brandName}"`);
                        return;
                    }

                    if (brand.tastes.length === 0) {
                        alert(`Пожалуйста, введите хотя бы один вкус для бренда "${brand.brandName}"`);
                        return;
                    }
                }

                // Показываем индикатор загрузки
                const saveButton = document.querySelector('.save-button');
                const originalText = saveButton.textContent;
                saveButton.textContent = 'Сохранение...';
                saveButton.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/multi-brand`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            deliveryId: this.currentDelivery.id,
                            brands: this.multiBrands.map(brand => ({
                                brandName: brand.brandName.trim(),
                                fortress: brand.fortress,
                                price: brand.price,
                                weight: brand.weight,
                                orderDate: brand.orderDate,
                                inventoryDate: brand.inventoryDate,
                                tastes: brand.tastes
                            }))
                        })
                    });

                    if (response.ok) {
                        // Сохраняем количество добавленных табаков перед очисткой
                        const addedCount = this.multiBrands.reduce((total, brand) => total + brand.tastes.length, 0);
                        
                        // Успешное сохранение
                        await this.loadTobaccos();
                        this.multiBrands = [];
                        // Закрываем форму после добавления табаков
                        this.showMultiBrandForm = false;
                        
                        // Обновляем интерфейс
                        this.render();
                        
                        // Показываем уведомление об успехе
                        this.showNotification(`Успешно добавлено ${addedCount} табаков в привоз!`, 'success');
                    } else {
                        const errorText = await response.text();
                        console.error('Ошибка сервера:', errorText);
                        alert('Ошибка при добавлении табаков: ' + (errorText || 'Неизвестная ошибка'));
                    }
                } catch (error) {
                    console.error('Ошибка при добавлении табаков:', error);
                    alert('Ошибка при добавлении табаков: ' + error.message);
                } finally {
                    // Восстанавливаем кнопку
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                }
            }

            async handleDeleteTobacco(id) {
                if (!confirm('Вы уверены, что хотите удалить этот табак?')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await this.loadTobaccos();
                        
                        // Обновляем таблицу для отображения изменений
                        this.updateTable();
                        
                        this.showNotification('Табак успешно удален!', 'success');
                    } else {
                        alert('Ошибка при удалении табака');
                    }
                } catch (error) {
                    console.error('Ошибка при удалении табака:', error);
                    alert('Ошибка при удалении табака');
                }
            }

            showNotification(message, type = 'info') {
                // Создаем элемент уведомления
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                
                // Добавляем стили для уведомления
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                    max-width: 300px;
                    word-wrap: break-word;
                `;
                
                // Цвета для разных типов уведомлений
                if (type === 'success') {
                    notification.style.backgroundColor = '#28a745';
                } else if (type === 'error') {
                    notification.style.backgroundColor = '#dc3545';
                } else {
                    notification.style.backgroundColor = '#6c757d';
                }
                
                // Добавляем в DOM
                document.body.appendChild(notification);
                
                // Анимация появления
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Автоматическое скрытие через 3 секунды
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            render() {
                const app = document.getElementById('root');
                
                if (!this.currentUser) {
                    app.innerHTML = this.renderLoginForm();
                    return;
                }

                app.innerHTML = `
                    <div class="app">
                        <div class="header">
                            <div class="header-content">
                                <div class="header-center">
                                    <h1>Hookah Staff</h1>
                                    <p>Управление табаками для кальянной</p>
                                </div>
                                <div class="header-profile">
                                    <div class="profile-info">
                                        <div class="profile-role">${this.currentUser.roleDisplayName}</div>
                                        <div class="profile-username">${this.currentUser.username}</div>
                                    </div>
                                    <button class="logout-button" onclick="app.logout()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M16 17v-3H9v-4h7V7l5 5-5 5zM14 2a2 2 0 0 1 2 2v2h-2V4H5v16h9v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"/>
                                        </svg>
                                        Выйти
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="tabs">
                            <button class="tab-button ${this.activeTab === 'current' ? 'active' : ''}" onclick="app.switchTab('current')">
                                Текущий привоз
                            </button>
                            <button class="tab-button ${this.activeTab === 'history' ? 'active' : ''}" onclick="app.switchTab('history')">
                                Прошлые привозы
                            </button>
                        </div>

                        ${this.activeTab === 'current' ? this.renderCurrentTab() : this.renderHistoryTab()}
                    </div>
                    
                    ${this.showDeliveryModal ? this.renderDeliveryModal() : ''}
                `;
            }

            renderDeliveryModal() {
                if (!this.selectedDelivery) return '';

                return `
                    <div class="modal-overlay" onclick="app.closeDeliveryModal()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3 class="modal-title">Детали привоза</h3>
                                <button class="modal-close" onclick="app.closeDeliveryModal()">&times;</button>
                            </div>
                            
                            <div class="delivery-cost-info" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; margin-bottom: 20px; border-radius: 12px; text-align: center; border: 1px solid #dee2e6;">
                                <h4 style="color: #495057; margin: 0 0 10px 0; font-size: 1.2rem;">Общая стоимость привоза</h4>
                                <div style="font-size: 2rem; font-weight: 700; color: #28a745;">${Math.round(this.selectedDelivery.cost || 0)} ₽</div>
                            </div>
                            
                            <div class="tobacco-table">
                                <div class="table-header">
                                    <h3>Табаки в привозе</h3>
                                </div>
                                ${this.renderDeliveryTobaccoTable()}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderDeliveryTobaccoTable() {
                if (!this.selectedDelivery || !this.selectedDelivery.tobaccos || this.selectedDelivery.tobaccos.length === 0) {
                    return `
                        <div class="empty-state">
                            <p>Табаки не найдены</p>
                        </div>
                    `;
                }

                return `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Бренд</th>
                                    <th>Вкус</th>
                                    <th>Крепость</th>
                                    <th>Цена</th>
                                    <th>Вес</th>
                                    <th>Дата заказа</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${this.selectedDelivery.tobaccos.map(tobacco => `
                                <tr>
                                    <td>${tobacco.brand_name || 'Не указано'}</td>
                                    <td>${tobacco.taste || 'Не указано'}</td>
                                    <td>
                                        <span class="fortress-badge ${this.getFortressClass(tobacco.fortress)}">
                                            ${this.getFortressText(tobacco.fortress)} (${tobacco.fortress}/5)
                                        </span>
                                    </td>
                                    <td class="price">${tobacco.price || 0} ₽</td>
                                    <td>${tobacco.weight || 50} г</td>
                                    <td>${tobacco.orderDate || 'Не указано'}</td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            renderLoginForm() {
                return `
                    <div class="app">
                        <div class="header">
                            <div class="header-content">
                                <div class="header-center">
                                    <h1>Hookah Staff</h1>
                                    <p>Управление табаками для кальянной</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="login-container">
                            <div class="login-card">
                                <div class="login-header">
                                    <div class="login-icon">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                        </svg>
                                    </div>
                                    <h2>Вход в систему</h2>
                                    <p>Войдите в свой аккаунт для доступа к системе</p>
                                </div>
                                
                                <div class="login-form">
                                    <div class="form-group">
                                        <label>Имя пользователя</label>
                                        <input type="text" id="username" placeholder="Введите имя пользователя" class="form-input">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Пароль</label>
                                        <input type="password" id="password" placeholder="Введите пароль" class="form-input">
                                    </div>
                                    
                                    <button onclick="app.handleLogin()" class="login-button">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
                                        </svg>
                                        Войти в систему
                                    </button>
                                </div>
                                
                                <div class="login-info">
                                    <div class="info-header">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                        </svg>
                                        Тестовые пользователи
                                    </div>
                                    <div class="info-content">
                                        <div class="user-role">
                                            <span class="role-name">Кальянный мастер:</span>
                                            <span class="role-credentials">master / master123</span>
                                        </div>
                                        <div class="user-role">
                                            <span class="role-name">Старший мастер:</span>
                                            <span class="role-credentials">senior / senior123</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderCurrentTab() {
                const isHookahMaster = this.currentUser && this.currentUser.role === 'HOOKAH_MASTER';
                
                return `
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${this.tobaccos.length}</div>
                            <div class="stat-label">Табаков в текущем привозе</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">
                                ${this.tobaccos.length > 0 ? Math.round(this.tobaccos.reduce((sum, t) => sum + (parseFloat(t.price) || 0), 0)) : 0}
                            </div>
                            <div class="stat-label">Стоимость привоза (₽)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${this.currentDelivery ? 'Активен' : 'Нет'}</div>
                            <div class="stat-label">Статус привоза</div>
                        </div>
                    </div>

                    ${isHookahMaster ? this.renderHookahMasterControls() : this.renderSeniorMasterControls()}

                    ${this.showMultiBrandForm ? this.renderMultiBrandForm() : ''}

                    <div class="tobacco-list">
                        <div class="tobacco-table">
                            <div class="table-header">
                                <h3>Текущий привоз</h3>
                            </div>
                            ${this.renderTobaccoTable()}
                        </div>
                    </div>
                `;
            }

            renderHookahMasterControls() {
                return `
                    <div class="delivery-controls" style="margin-bottom: 30px; text-align: center;">
                        ${!this.currentDelivery ? `
                            <button class="add-button" onclick="app.createNewDeliveryWithForm()">
                                Создать новый привоз
                            </button>
                        ` : `
                            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                <button class="add-button" onclick="app.toggleMultiBrandForm()">
                                    ${this.showMultiBrandForm ? 'Отмена' : 'Добавить табаки'}
                                </button>
                                <button class="add-button" onclick="app.finalizeDelivery()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                    Зафиксировать привоз
                                </button>
                                <button class="add-button" onclick="app.cancelDelivery()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                    Отменить привоз
                                </button>
                            </div>
                        `}
                    </div>
                `;
            }

            renderSeniorMasterControls() {
                return `
                    <div class="delivery-controls" style="margin-bottom: 30px; text-align: center;">
                        ${!this.currentDelivery ? `
                            <button class="add-button" onclick="app.createNewDelivery()">
                                Создать новый привоз
                            </button>
                        ` : `
                            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                <button class="add-button" onclick="app.finalizeDelivery()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                    Зафиксировать привоз
                                </button>
                                <button class="add-button" onclick="app.cancelDelivery()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                    Отменить привоз
                                </button>
                            </div>
                        `}
                    </div>

                    <div class="add-button-container">
                        <button class="add-button" onclick="app.toggleMultiBrandForm()">
                            ${this.showMultiBrandForm ? 'Отмена' : 'Добавить табаки'}
                        </button>
                    </div>
                `;
            }

            renderHistoryTab() {
                return `
                    <div class="history-container">
                        <h2 style="text-align: center; margin-bottom: 30px; color: #495057;">История привозов</h2>
                        
                        ${this.finalizedDeliveries.length === 0 ? `
                            <div class="empty-state">
                                <p>Нет завершенных привозов</p>
                                <p>Завершите первый привоз, чтобы увидеть его здесь</p>
                            </div>
                        ` : `
                            <div class="delivery-cards">
                                ${this.finalizedDeliveries.map(delivery => `
                                    <div class="delivery-card" onclick="app.showDeliveryDetails(${delivery.id})">
                                        <div class="delivery-date">
                                            ${new Date(delivery.deliveryDate).toLocaleDateString('ru-RU')}
                                        </div>
                                        <div class="delivery-info">
                                            <div>Создан: ${delivery.createdBy}</div>
                                            <div>Завершен: ${new Date(delivery.finalizedAt).toLocaleDateString('ru-RU')}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
            }



            renderMultiBrandForm() {
                return `
                    <div class="add-form">
                        <h3>Добавить табаки</h3>
                        <div class="brands-container">
                            ${this.multiBrands.map((brand, index) => `
                                <div class="brand-form" style="border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: #f8f9fa;">
                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                        <h4 style="margin: 0; color: #495057;">Бренд ${index + 1}</h4>
                                        ${this.multiBrands.length > 1 ? `
                                            <button type="button" onclick="app.removeBrand(${index})" 
                                                    style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">
                                                Удалить бренд
                                            </button>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Название бренда:</label>
                                        <input
                                            type="text"
                                            value="${brand.brandName}"
                                            onchange="app.updateBrand(${index}, 'brandName', this.value)"
                                            placeholder="Например: Darkside"
                                        />
                                        ${this.renderSuggestions(this.brandSuggestions, 'brand', index)}
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Крепость: ${brand.fortress}/5</label>
                                        <input
                                            type="range"
                                            min="1"
                                            max="5"
                                            value="${brand.fortress}"
                                            onchange="app.updateBrand(${index}, 'fortress', parseInt(this.value))"
                                        />
                                        <span class="fortress-text">${this.getFortressText(brand.fortress)}</span>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Цена за пачку (₽):</label>
                                        <input
                                            type="number"
                                            value="${brand.price}"
                                            onchange="app.updateBrand(${index}, 'price', parseFloat(this.value) || 0)"
                                            placeholder="1200"
                                        />
                                        ${this.renderSuggestions(this.priceSuggestions, 'price', index)}
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Вес пачки (г):</label>
                                        <input
                                            type="number"
                                            value="${brand.weight}"
                                            onchange="app.updateBrand(${index}, 'weight', parseInt(this.value) || 50)"
                                            placeholder="50"
                                            readonly
                                            style="background-color: #f8f9fa; color: #6c757d;"
                                        />
                                        <small style="color: #6c757d; font-size: 0.8rem;">Вес автоматически устанавливается при выборе цены</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Вкусы (через запятую):</label>
                                        <textarea
                                            rows="3"
                                            placeholder="Малина, Смородина, Клубника"
                                            onchange="app.updateBrandTastes(${index}, this.value)"
                                            style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; resize: vertical;"
                                        >${brand.tastes.join(', ')}</textarea>
                                        <small style="color: #6c757d; font-size: 0.8rem; display: block; margin-top: 5px;">
                                            💡 Можно нажимать на один вкус несколько раз для добавления нескольких пачек
                                        </small>
                                        ${this.renderSuggestions(this.tasteSuggestions, 'taste', index)}
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Предварительный просмотр:</label>
                                        <div style="background: #ffffff; padding: 10px; border-radius: 6px; border: 1px solid #e9ecef;">
                                            ${brand.tastes.length > 0 ? 
                                                (() => {
                                                    const tasteCounts = this.getTasteCounts(brand.tastes);
                                                    return Object.entries(tasteCounts).map(([taste, count]) => `
                                                        <div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                                                            <div>
                                                                <strong>${brand.brandName || 'Бренд'}</strong> - ${taste.trim()} ${count > 1 ? `(${count} шт.)` : ''}
                                                                <br><small>Крепость: ${this.getFortressText(brand.fortress)}, Цена: ${brand.price || 0} ₽, Вес: ${brand.weight || 50} г</small>
                                                            </div>
                                                            <button type="button" onclick="app.removeTasteSuggestion(${index}, '${taste}')" 
                                                                    style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 0.7rem; cursor: pointer; margin-left: 10px;">
                                                                ×
                                                            </button>
                                                        </div>
                                                    `).join('');
                                                })() : 
                                                '<div style="color: #6c757d; font-style: italic;">Введите вкусы для предварительного просмотра</div>'
                                            }
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button type="button" onclick="app.addNewBrand()" 
                                    style="background: #28a745; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer;">
                                + Добавить еще один бренд
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label>Общий предварительный просмотр:</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; max-height: 300px; overflow-y: auto;">
                                ${this.multiBrands.some(brand => brand.tastes.length > 0) ? 
                                    this.multiBrands.map((brand, brandIndex) => 
                                        brand.tastes.length > 0 ? `
                                            <div style="margin-bottom: 15px;">
                                                <h5 style="margin: 0 0 10px 0; color: #495057;">${brand.brandName || `Бренд ${brandIndex + 1}`}</h5>
                                                ${(() => {
                                                    const tasteCounts = this.getTasteCounts(brand.tastes);
                                                    return Object.entries(tasteCounts).map(([taste, count]) => `
                                                        <div style="margin: 5px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                                                            <div>
                                                                <strong>${taste.trim()}</strong> ${count > 1 ? `(${count} шт.)` : ''}
                                                                <br><small>Крепость: ${this.getFortressText(brand.fortress)}, Цена: ${brand.price || 0} ₽, Вес: ${brand.weight || 50} г</small>
                                                            </div>
                                                            <button type="button" onclick="app.removeTasteSuggestion(${brandIndex}, '${taste}')" 
                                                                    style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 0.7rem; cursor: pointer; margin-left: 10px;">
                                                                ×
                                                            </button>
                                                        </div>
                                                    `).join('');
                                                })()}
                                            </div>
                                        ` : ''
                                    ).join('') : 
                                    '<div style="color: #6c757d; font-style: italic;">Добавьте бренды и вкусы для предварительного просмотра</div>'
                                }
                            </div>
                        </div>
                        
                        <button class="save-button" onclick="app.handleMultiBrandAddTobaccos()">
                            ${this.currentUser && this.currentUser.role === 'HOOKAH_MASTER' ? 
                                `Добавить ${this.multiBrands.reduce((total, brand) => total + brand.tastes.length, 0)} табаков в привоз` : 
                                `Добавить ${this.multiBrands.reduce((total, brand) => total + brand.tastes.length, 0)} табаков`
                            }
                        </button>
                    </div>
                `;
            }

            renderTobaccoTable() {
                if (this.tobaccos.length === 0) {
                    return `
                        <div class="empty-state">
                            <p>Табаки не найдены</p>
                            <p>Добавьте первый табак в привоз</p>
                        </div>
                    `;
                }

                // Определяем, показывать ли поля инвентаризации
                const showInventoryFields = this.currentUser && this.currentUser.role === 'SENIOR_HOOKAH_MASTER';

                return `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Бренд</th>
                                    <th>Вкус</th>
                                    <th>Крепость</th>
                                    <th>Цена</th>
                                    <th>Вес</th>
                                    <th>Дата заказа</th>
                                    ${showInventoryFields ? `
                                        <th>Дата инвентаризации</th>
                                        <th>Вес на инвентаризации</th>
                                        <th>Использование</th>
                                    ` : ''}
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${this.tobaccos.map(tobacco => {
                                const usagePercentage = this.calculateUsagePercentage(tobacco);
                                const usageColor = this.getUsageColor(usagePercentage);
                                return `
                                <tr>
                                    <td>${tobacco.brand_name || 'Не указано'}</td>
                                    <td>${tobacco.taste || 'Не указано'}</td>
                                    <td>
                                        <span class="fortress-badge ${this.getFortressClass(tobacco.fortress)}">
                                            ${this.getFortressText(tobacco.fortress)} (${tobacco.fortress}/5)
                                        </span>
                                    </td>
                                    <td class="price">${tobacco.price || 0} ₽</td>
                                    <td>${tobacco.weight || 50} г</td>
                                    <td>${tobacco.orderDate || 'Не указано'}</td>
                                    ${showInventoryFields ? `
                                        <td>${tobacco.inventoryDate || 'Не указано'}</td>
                                        <td>
                                            <input 
                                                type="number" 
                                                value="${this.getInventoryWeightInGrams(tobacco)}" 
                                                min="0" 
                                                max="${tobacco.weight || 50}"
                                                style="width: 100%; max-width: 80px; padding: 4px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;"
                                                onchange="app.updateInventoryWeight(${tobacco.id}, this.value)"
                                            /> г
                                        </td>
                                        <td>
                                            <span style="color: ${usageColor}; font-weight: bold;">
                                                ${usagePercentage}%
                                            </span>
                                        </td>
                                    ` : ''}
                                    <td>
                                        <button class="delete-button" onclick="app.handleDeleteTobacco(${tobacco.id})">
                                            Удалить
                                        </button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }


            toggleMultiBrandForm() {
                this.showMultiBrandForm = !this.showMultiBrandForm;
                if (this.showMultiBrandForm) {
                    // Инициализируем с одним брендом, если список пуст
                    if (this.multiBrands.length === 0) {
                        this.addNewBrand();
                    }
                }
                this.render();
            }


            addNewBrand() {
                this.multiBrands.push({
                    brandName: '',
                    fortress: 1,
                    price: 720, // Устанавливаем цену по умолчанию
                    weight: 100, // Устанавливаем вес по умолчанию (соответствует цене 720₽)
                    orderDate: new Date().toISOString().split('T')[0],
                    inventoryDate: new Date().toISOString().split('T')[0],
                    tastes: []
                });
                this.render();
            }

            removeBrand(index) {
                this.multiBrands.splice(index, 1);
                this.render();
            }

            updateBrand(index, field, value) {
                if (this.multiBrands[index]) {
                    this.multiBrands[index][field] = value;
                    
                    // Если изменилась цена, автоматически обновляем вес
                    if (field === 'price') {
                        const weight = this.priceToWeightMapping[value];
                        if (weight) {
                            this.multiBrands[index].weight = weight;
                        }
                    }
                    
                    this.render();
                }
            }

            updateBrandTastes(index, tastesText) {
                if (this.multiBrands[index]) {
                    this.multiBrands[index].tastes = tastesText
                        .split(',')
                        .map(taste => taste.trim())
                        .filter(taste => taste.length > 0);
                    this.render();
                }
            }

            // Функция для подсчета количества каждого вкуса
            getTasteCounts(tastes) {
                const counts = {};
                tastes.forEach(taste => {
                    counts[taste] = (counts[taste] || 0) + 1;
                });
                return counts;
            }

            // Функция для удаления одного экземпляра вкуса
            removeTasteSuggestion(brandIndex, taste) {
                const currentTastes = this.multiBrands[brandIndex].tastes;
                const index = currentTastes.indexOf(taste);
                if (index > -1) {
                    currentTastes.splice(index, 1);
                    this.updateBrandTastes(brandIndex, currentTastes.join(', '));
                }
            }



            async updateInventoryWeight(tobaccoId, newWeight) {
                try {
                    const tobacco = this.tobaccos.find(t => t.id === tobaccoId);
                    if (!tobacco) return;

                    const weightInGrams = parseInt(newWeight);
                    const maxWeight = tobacco.weight || 50;
                    
                    // Валидация: вес инвентаризации не может быть больше исходного веса
                    if (weightInGrams > maxWeight) {
                        alert(`Вес инвентаризации не может быть больше ${maxWeight} г`);
                        return;
                    }
                    
                    if (weightInGrams < 0) {
                        alert('Вес инвентаризации не может быть отрицательным');
                        return;
                    }

                    const response = await fetch(`${API_BASE_URL}/${tobaccoId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...tobacco,
                            inventoryWeight: weightInGrams, // Сохраняем в граммах
                            inventoryDate: new Date().toISOString().split('T')[0]
                        })
                    });

                    if (response.ok) {
                        // Обновляем локальные данные
                        tobacco.inventoryWeight = weightInGrams;
                        tobacco.inventoryDate = new Date().toISOString().split('T')[0];
                        
                        // Обновляем только строку таблицы
                        this.updateTableRow(tobaccoId);
                        
                        this.showNotification('Вес инвентаризации обновлен!', 'success');
                    } else {
                        alert('Ошибка при обновлении веса инвентаризации');
                    }
                } catch (error) {
                    console.error('Ошибка при обновлении веса инвентаризации:', error);
                    alert('Ошибка при обновлении веса инвентаризации');
                }
            }

            updateTableRow(tobaccoId) {
                const tobacco = this.tobaccos.find(t => t.id === tobaccoId);
                if (!tobacco) return;

                const usagePercentage = this.calculateUsagePercentage(tobacco);
                const usageColor = this.getUsageColor(usagePercentage);

                // Находим строку таблицы и обновляем колонки
                const table = document.querySelector('.table tbody');
                if (table) {
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const deleteButton = row.querySelector('.delete-button');
                        if (deleteButton && deleteButton.onclick.toString().includes(tobaccoId)) {
                            // Обновляем колонку "Вес на инвентаризации" (индекс 7)
                            const inventoryWeightCell = row.cells[7];
                            if (inventoryWeightCell) {
                                inventoryWeightCell.innerHTML = `
                                    <input 
                                        type="number" 
                                        value="${this.getInventoryWeightInGrams(tobacco)}" 
                                        min="0" 
                                        max="${tobacco.weight || 50}"
                                        style="width: 100%; max-width: 80px; padding: 4px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;"
                                        onchange="app.updateInventoryWeight(${tobacco.id}, this.value)"
                                    /> г
                                `;
                            }
                            
                            // Обновляем колонку "Использование" (индекс 8)
                            const usageCell = row.cells[8];
                            if (usageCell) {
                                usageCell.innerHTML = `
                                    <span style="color: ${usageColor}; font-weight: bold;">
                                        ${usagePercentage}%
                                    </span>
                                `;
                            }
                        }
                    });
                }
            }

            updateTable() {
                // Обновляем только таблицу и статистику
                const tobaccoList = document.querySelector('.tobacco-list');
                if (tobaccoList) {
                    tobaccoList.innerHTML = `
                        <div class="tobacco-table">
                            <div class="table-header">
                                <h3>Каталог табаков</h3>
                            </div>
                            ${this.renderTobaccoTable()}
                        </div>
                    `;
                }

                // Обновляем статистику
                const stats = document.querySelector('.stats');
                if (stats) {
                    stats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${this.tobaccos.length}</div>
                            <div class="stat-label">Табаков в каталоге</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">
                                ${this.tobaccos.length > 0 ? Math.round(this.tobaccos.reduce((sum, t) => sum + (parseFloat(t.price) || 0), 0)) : 0}
                            </div>
                            <div class="stat-label">Стоимость привоза (₽)</div>
                        </div>
                    `;
                }
            }
        }

        // Инициализация приложения
        const app = new HookahStaffApp();
    </script>
</body>
</html>
