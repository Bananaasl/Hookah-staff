<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="merge-duplicate-tobaccos-1" author="system">
        <comment>Объединяет дубликаты табаков с одинаковым брендом и вкусом, но разной ценой</comment>
        <sql>
            -- Создаем временную таблицу для хранения маппинга старых ID на новые
            CREATE TEMP TABLE tobacco_id_mapping AS
            WITH ranked_tobaccos AS (
                SELECT 
                    id,
                    brand_name,
                    taste,
                    price,
                    relevance_score,
                    ROW_NUMBER() OVER (
                        PARTITION BY brand_name, taste 
                        ORDER BY relevance_score DESC, id ASC
                    ) as rn
                FROM tobacco
            ),
            keep_tobaccos AS (
                SELECT id as keep_id, brand_name, taste
                FROM ranked_tobaccos
                WHERE rn = 1
            ),
            duplicate_tobaccos AS (
                SELECT rt.id as duplicate_id, kt.keep_id
                FROM ranked_tobaccos rt
                JOIN keep_tobaccos kt ON rt.brand_name = kt.brand_name AND rt.taste = kt.taste
                WHERE rt.rn > 1
            )
            SELECT duplicate_id, keep_id
            FROM duplicate_tobaccos;

            -- Обновляем ссылки в delivery_tobacco на объединенные табаки
            UPDATE delivery_tobacco dt
            SET tobacco_id = mapping.keep_id
            FROM tobacco_id_mapping mapping
            WHERE dt.tobacco_id = mapping.duplicate_id;

            -- Удаляем дубликаты из таблицы tobacco
            DELETE FROM tobacco
            WHERE id IN (SELECT duplicate_id FROM tobacco_id_mapping);

            -- Удаляем временную таблицу
            DROP TABLE tobacco_id_mapping;
        </sql>
    </changeSet>

</databaseChangeLog>
